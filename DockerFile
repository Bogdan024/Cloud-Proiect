FROM node:18-alpine AS runner
WORKDIR /app
ENV NODE_ENV production

# Copy standalone app + its modules
COPY --from=builder /app/.next/standalone/package.json ./
COPY --from=builder /app/.next/standalone/node_modules ./node_modules
COPY --from=builder /app/.next/standalone/server.js ./server.js

# Static assets
COPY --from=builder /app/.next/static    ./.next/static
COPY --from=builder /app/public          ./public

# Drop privileges
RUN addgroup --system --gid 1001 nodejs
RUN adduser  --system --uid 1001 nextjs
USER nextjs

EXPOSE 3000
CMD ["node", "server.js"]
